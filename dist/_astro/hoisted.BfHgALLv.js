import"https://d3js.org/d3.v7.min.js";import"./hoisted.lCUHE6ev.js";let g=[],u=[];const x={Total:"#6B7280","COVID-19":"#1E40AF",RSV:"#EA580C",Influenza:"#EAB308",Adenovirus:"#610b00","Human Metapneumovirus":"#16A34A","Parainfluenza Virus 1-4":"#7C3AED",Rhinovirus:"#1192e8","Seasonal Coronavirus":"#EC4899",Parainfluenza:"#7C3AED",Metapneumovirus:"#16A34A",Enterovirus:"#002d9c",Bocavirus:"#ee538b",Other:"#b28600"};document.addEventListener("DOMContentLoaded",function(){console.log("Loading respiratory virus data..."),F()});async function F(){try{console.log("Starting to load all data...");const[t,e]=await Promise.all([S().catch(a=>(console.error("Hospitalization data error:",a),[])),N().catch(a=>(console.error("Laboratory data error:",a),[]))]);g=t,u=e,console.log("All data loaded:",{hospitalizations:g.length,laboratory:u.length}),setTimeout(()=>{g.length>0?P():(console.warn("No hospitalization data available"),A()),u.length>0?R():(console.warn("No laboratory data available"),C()),X()},100)}catch(t){console.error("Error loading data:",t),J()}}async function S(){const t=await fetch("/data/MDHRespiratoryData10.9.25/MDH-statewide-hospitalizations-since-2022.csv");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=(await t.text()).split(`
`).filter(o=>o.trim()),n=[];for(let o=1;o<a.length;o++){const r=a[o].split("	");if(r.length>=15){const l=r[0]?.trim(),d=r[11]?.trim()||"Total",s=r[14]?.trim();if(l&&s){const i=parseFloat(s);if(!isNaN(i)&&i>=0){const h=k(l);h&&n.push({date:h,pathogen:d,value:i,metric:"Hospitalization Rate"})}}}}return n}async function N(){const t=await fetch("/data/MDHRespiratoryData10.9.25/MDH-laboratory-system-molecular-data-1-year-10.9.25.csv");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=(await t.text()).split(`
`).filter(o=>o.trim()),n=[];for(let o=1;o<a.length;o++){const r=a[o].split("	");if(r.length>=3){const l=r[0]?.trim(),d=r[1]?.trim(),s=r[2]?.trim();if(!l||!d||!s)continue;const i=parseFloat(s);if(l&&d&&!isNaN(i)&&i>0){const h=k(d);h&&n.push({date:h,pathogen:l,value:i,metric:"Laboratory Detections"})}}}return n}function P(){V(),y(),q()}function R(){Y(),v(),G()}function k(t){if(!t||t.trim()==="")return null;const e=t.trim();let a=null;if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(e)?a=new Date(e):/^\d{4}-\d{1,2}-\d{1,2}$/.test(e)?a=new Date(e):a=new Date(e),a&&!isNaN(a.getTime())){const n=a.getFullYear();if(n>=2020&&n<=2025)return a}return console.log("Failed to parse date:",e),null}function V(){const t=new Set;g.forEach(a=>{a.pathogen&&a.pathogen!=="Unknown"&&t.add(a.pathogen)});const e=document.getElementById("hosp-pathogen-filter");if(e){for(;e.children.length>1;)e.removeChild(e.lastChild);Array.from(t).sort().forEach(a=>{const n=document.createElement("option");n.value=a,n.textContent=a,e.appendChild(n)})}}function Y(){const t=new Set;u.forEach(a=>{a.pathogen&&a.pathogen!=="Unknown"&&t.add(a.pathogen)});const e=document.getElementById("lab-pathogen-filter");if(e){for(;e.children.length>1;)e.removeChild(e.lastChild);Array.from(t).sort().forEach(a=>{const n=document.createElement("option");n.value=a,n.textContent=a,e.appendChild(n)})}}function y(){const t=document.getElementById("hosp-container");if(!t)return;d3.select(t).selectAll("*").remove();const e=O();if(e.length===0){f(t,"No hospitalization data available for the selected filters");return}D(t,e,"Hospitalization Rate",x["COVID-19"])}function v(){const t=document.getElementById("lab-container");if(!t)return;d3.select(t).selectAll("*").remove();const e=W();if(e.length===0){f(t,"No laboratory data available for the selected filters");return}D(t,e,"Laboratory Detections",x.RSV)}function j(t,e,a){const n=t.append("g").attr("class","legend").attr("transform",`translate(${e+10}, 20)`);a.slice(0,8).forEach((o,r)=>{const[l,d]=o.split("-"),s=x[l]||"#6B7280",i=n.append("g").attr("transform",`translate(0, ${r*20})`);i.append("line").attr("x1",0).attr("x2",15).attr("stroke",s).attr("stroke-width",2),i.append("text").attr("x",20).attr("y",0).attr("dy","0.35em").style("font-size","11px").style("fill","#374151").text(l)})}function D(t,e,a,n){if(t.clientWidth===0){console.log("Container width is 0, waiting for layout..."),setTimeout(()=>{t.clientWidth>0?D(t,e,a,n):f(t,"Chart container not ready. Please refresh the page.")},100);return}const o={top:20,right:180,bottom:60,left:80},r=Math.max(300,t.clientWidth-o.left-o.right),l=400-o.top-o.bottom;if(!e||e.length===0){f(t,"No data available for this chart.");return}try{const s=d3.select(t).append("svg").attr("width",r+o.left+o.right).attr("height",l+o.top+o.bottom).append("g").attr("transform",`translate(${o.left},${o.top})`),i=d3.extent(e,c=>c.date),h=d3.extent(e,c=>c.value),b=d3.scaleTime().domain(i).range([0,r]),E=d3.scaleLinear().domain([0,h[1]*1.1]).range([l,0]),M=d3.axisBottom(b).tickFormat(d3.timeFormat("%b %Y")),I=d3.axisLeft(E);s.append("g").attr("class","x-axis").attr("transform",`translate(0,${l})`).call(M).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)"),s.append("g").attr("class","y-axis").call(I);const L=d3.group(e,c=>`${c.pathogen}-${c.metric||"default"}`),T=d3.line().x(c=>b(c.date)).y(c=>E(c.value)).curve(d3.curveLinear);L.forEach((c,$)=>{const[m,H]=$.split("-"),z=c.sort((p,w)=>p.date-w.date),B=x[m]||n;s.append("path").datum(z).attr("class",`line pathogen-${m.replace(/[^a-zA-Z0-9]/g,"")}`).attr("fill","none").attr("stroke",B).attr("stroke-width",2).attr("opacity",.8).attr("d",T),s.selectAll(`.dot-${m.replace(/[^a-zA-Z0-9]/g,"")}-${H}`).data(z).enter().append("circle").attr("class",`dot pathogen-${m.replace(/[^a-zA-Z0-9]/g,"")}`).attr("cx",p=>b(p.date)).attr("cy",p=>E(p.value)).attr("r",3).attr("fill",B).attr("opacity",.7).on("mouseover",function(p,w){Z(p,w)}).on("mouseout",U)}),j(s,r,Array.from(L.keys())),s.append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("y",0-o.left).attr("x",0-l/2).attr("dy","1em").style("text-anchor","middle").style("font-size","12px").style("fill","#6B7280").text(a),s.append("text").attr("class","axis-label").attr("transform",`translate(${r/2}, ${l+o.bottom-10})`).style("text-anchor","middle").style("font-size","12px").style("fill","#6B7280").text("Date")}catch(d){console.error("Error creating chart:",d),f(t,"Error creating chart. Please refresh the page.")}}function O(){let t=[...g];const e=document.getElementById("hosp-pathogen-filter")?.value;e&&(t=t.filter(n=>n.pathogen===e));const a=document.getElementById("hosp-date-range")?.value;if(a&&a!=="all"){const n=new Date;let o=new Date;switch(a){case"3months":o.setMonth(n.getMonth()-3);break;case"6months":o.setMonth(n.getMonth()-6);break;case"1year":o.setFullYear(n.getFullYear()-1);break}t=t.filter(r=>r.date>=o)}return t}function W(){let t=[...u];const e=document.getElementById("lab-pathogen-filter")?.value;e&&(t=t.filter(n=>n.pathogen===e));const a=document.getElementById("lab-date-range")?.value;if(a&&a!=="all"){const n=new Date;let o=new Date;switch(a){case"1month":o.setMonth(n.getMonth()-1);break;case"3months":o.setMonth(n.getMonth()-3);break;case"6months":o.setMonth(n.getMonth()-6);break}t=t.filter(r=>r.date>=o)}return t}function Z(t,e){d3.select("body").append("div").attr("class","chart-tooltip").style("position","absolute").style("background","rgba(0, 0, 0, 0.8)").style("color","white").style("padding","8px 12px").style("border-radius","4px").style("font-size","12px").style("pointer-events","none").style("z-index","1000").html(`
          <strong>${e.pathogen}</strong><br/>
          ${e.metric}: ${e.value.toLocaleString()}<br/>
          Date: ${e.date.toLocaleDateString()}
        `).style("left",t.pageX+10+"px").style("top",t.pageY-10+"px")}function U(){d3.selectAll(".chart-tooltip").remove()}function f(t,e){d3.select(t).append("div").style("text-align","center").style("padding","2rem").style("color","#6B7280").text(e)}function X(){document.getElementById("hosp-pathogen-filter")?.addEventListener("change",()=>{y()}),document.getElementById("hosp-date-range")?.addEventListener("change",()=>{y()}),document.getElementById("lab-pathogen-filter")?.addEventListener("change",()=>{v()}),document.getElementById("lab-date-range")?.addEventListener("change",()=>{v()});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{y(),v()},250)})}function q(){const t=document.getElementById("hosp-loading"),e=document.getElementById("hosp-chart");t&&(t.style.display="none"),e&&e.classList.remove("hidden")}function G(){const t=document.getElementById("lab-loading"),e=document.getElementById("lab-chart");t&&(t.style.display="none"),e&&e.classList.remove("hidden")}function J(){A(),C()}function A(){const t=document.getElementById("hosp-loading");t&&(t.innerHTML=`
          <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-red-600">Error loading hospitalization data</p>
          </div>
        `)}function C(){const t=document.getElementById("lab-loading");t&&(t.innerHTML=`
          <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-red-600">Error loading laboratory data</p>
          </div>
        `)}
