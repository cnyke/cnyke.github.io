import"https://d3js.org/d3.v7.min.js";import"./hoisted.t_BYlHZp.js";let v=[],E=[];const C={Total:"#6B7280","COVID-19":"#1E40AF",COVID:"#1E40AF",RSV:"#EA580C",Influenza:"#EAB308",Adenovirus:"#610b00","Human Metapneumovirus":"#16A34A","Parainfluenza Virus 1-4":"#EA580C","Parainfluenza Virus 1":"#EA580C",Rhinovirus:"#1192e8","Seasonal Coronavirus":"#EC4899",Parainfluenza:"#EA580C",Metapneumovirus:"#16A34A",Enterovirus:"#002d9c",Bocavirus:"#ee538b",Other:"#b28600"};document.addEventListener("DOMContentLoaded",function(){console.log("Loading respiratory virus data..."),P()});async function P(){try{console.log("Starting to load all data...");const[t,e]=await Promise.all([V().catch(o=>(console.error("Hospitalization data error:",o),[])),O().catch(o=>(console.error("Laboratory data error:",o),[]))]);v=t,E=e,console.log("All data loaded:",{hospitalizations:v.length,laboratory:E.length}),setTimeout(()=>{v.length>0?X():(console.warn("No hospitalization data available"),N()),E.length>0?j():(console.warn("No laboratory data available"),R()),_()},100)}catch(t){console.error("Error loading data:",t),ot()}}async function V(){const t=await fetch("/data/MDHRespiratoryData10.9.25/MDH-statewide-hospitalizations-since-2022.csv");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=(await t.text()).split(`
`).filter(n=>n.trim()),a=[];for(let n=1;n<o.length;n++){const l=o[n].split("	");if(l.length>=15){const r=l[0]?.trim(),p=l[11]?.trim()||"Total",c=l[14]?.trim();if(r&&c){const d=parseFloat(c);if(!isNaN(d)&&d>=0){const i=S(r);i&&a.push({date:i,pathogen:p,value:d,metric:"Hospitalization Rate"})}}}}return a}async function O(){const t=await fetch("/data/MDHRespiratoryData10.9.25/MDH-laboratory-system-molecular-data-1-year-10.9.25.csv");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=(await t.text()).split(`
`).filter(n=>n.trim()),a=[];for(let n=1;n<o.length;n++){const l=o[n].split("	");if(l.length>=3){const r=l[0]?.trim(),p=l[1]?.trim(),c=l[2]?.trim();if(!r||!p||!c)continue;const d=parseFloat(c);if(r&&p&&!isNaN(d)&&d>0){const i=S(p);i&&a.push({date:i,pathogen:r,value:d,metric:"Laboratory Detections"})}}}return a}function X(){Z(),L(),tt()}function j(){U(),A(),et()}function S(t){if(!t||t.trim()==="")return null;const e=t.trim();let o=null;if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(e)?o=new Date(e):/^\d{4}-\d{1,2}-\d{1,2}$/.test(e)?o=new Date(e):o=new Date(e),o&&!isNaN(o.getTime())){const a=o.getFullYear();if(a>=2020&&a<=2025)return o}return console.log("Failed to parse date:",e),null}function Z(){const t=new Set;v.forEach(o=>{o.pathogen&&o.pathogen!=="Unknown"&&t.add(o.pathogen)});const e=document.getElementById("hosp-pathogen-filter");if(e){for(;e.children.length>1;)e.removeChild(e.lastChild);Array.from(t).sort().forEach(o=>{const a=document.createElement("option");a.value=o,a.textContent=o,e.appendChild(a)})}}function U(){const t=new Set;E.forEach(o=>{o.pathogen&&o.pathogen!=="Unknown"&&t.add(o.pathogen)});const e=document.getElementById("lab-pathogen-filter");if(e){for(;e.children.length>1;)e.removeChild(e.lastChild);Array.from(t).sort().forEach(o=>{const a=document.createElement("option");a.value=o,a.textContent=o,e.appendChild(a)})}}function L(){const t=document.getElementById("hosp-container");if(!t)return;d3.select(t).selectAll("*").remove();const e=G();if(e.length===0){D(t,"No hospitalization data available for the selected filters");return}H(t,e,"Hospitalization Rate",C["COVID-19"])}function A(){const t=document.getElementById("lab-container");if(!t)return;d3.select(t).selectAll("*").remove();const e=J();if(e.length===0){D(t,"No laboratory data available for the selected filters");return}H(t,e,"Laboratory Detections",C.RSV)}function q(t,e,o){const a=window.innerWidth<640,n=window.innerWidth<1024,l=t.append("g").attr("class","legend").attr("transform",`translate(${e+10}, 20)`),r=a?4:n?6:8;o.slice(0,r).forEach((p,c)=>{const[d,i]=p.split("-"),w=C[d]||"#6B7280",u=l.append("g").attr("transform",`translate(0, ${c*(a?16:20)})`);u.append("line").attr("x1",0).attr("x2",a?12:15).attr("stroke",w).attr("stroke-width",a?1.5:2),u.append("text").attr("x",a?16:20).attr("y",0).attr("dy","0.35em").style("font-size",a?"9px":"11px").style("fill","#374151").text(d)})}function H(t,e,o,a){if(t.clientWidth===0){console.log("Container width is 0, waiting for layout..."),setTimeout(()=>{t.clientWidth>0?H(t,e,o,a):D(t,"Chart container not ready. Please refresh the page.")},100);return}const n=window.innerWidth<640,l=window.innerWidth<1024,r=n?{top:20,right:20,bottom:70,left:50}:l?{top:20,right:100,bottom:80,left:60}:{top:20,right:180,bottom:80,left:80},p=Math.max(250,t.clientWidth-r.left-r.right),c=Math.max(200,t.clientHeight||300)-r.top-r.bottom;if(!e||e.length===0){D(t,"No data available for this chart.");return}try{const i=d3.select(t).append("svg").attr("width",p+r.left+r.right).attr("height",c+r.top+r.bottom).append("g").attr("transform",`translate(${r.left},${r.top})`),w=d3.extent(e,s=>s.date),u=d3.extent(e,s=>s.value),m=d3.scaleTime().domain(w).range([0,p]),h=u[1]*1.1;let f,g,y;if(h<=1)y=[0,1],f=[0,.5,1],g=".1f";else if(h>50){y=[0,h];const s=20;f=d3.range(0,Math.ceil(h)+s,s),g=".0f"}else{y=[0,h];const s=Math.min(Math.ceil(h),10);f=d3.range(0,Math.ceil(h)+1,Math.max(1,Math.ceil(h/s))),f=[...new Set(f)].filter(k=>k<=Math.ceil(h)),g=".0f"}const b=d3.scaleLinear().domain(y).range([c,0]),B=d3.axisBottom(m).tickFormat(d3.timeFormat("%b %Y")),I=d3.axisLeft(b).tickValues(f).tickFormat(d3.format(g));i.append("g").attr("class","x-axis").attr("transform",`translate(0,${c})`).call(B).selectAll("text").style("text-anchor","end").style("font-size",n?"10px":"12px").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)"),i.append("g").attr("class","y-axis").call(I).selectAll("text").style("font-size",n?"10px":"12px");const M=d3.group(e,s=>`${s.pathogen}-${s.metric||"default"}`),W=d3.line().x(s=>m(s.date)).y(s=>b(s.value)).curve(d3.curveLinear);M.forEach((s,k)=>{const[z,Y]=k.split("-"),F=s.sort((x,$)=>x.date-$.date),T=C[z]||a;i.append("path").datum(F).attr("class",`line pathogen-${z.replace(/[^a-zA-Z0-9]/g,"")}`).attr("fill","none").attr("stroke",T).attr("stroke-width",2).attr("opacity",.8).attr("d",W),i.selectAll(`.dot-${z.replace(/[^a-zA-Z0-9]/g,"")}-${Y}`).data(F).enter().append("circle").attr("class",`dot pathogen-${z.replace(/[^a-zA-Z0-9]/g,"")}`).attr("cx",x=>m(x.date)).attr("cy",x=>b(x.value)).attr("r",3).attr("fill",T).attr("opacity",.7).on("mouseover",function(x,$){K(x,$,T)}).on("mouseout",Q)}),n||q(i,p,Array.from(M.keys())),i.append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("y",0-r.left).attr("x",0-c/2).attr("dy","1em").style("text-anchor","middle").style("font-size",n?"10px":"12px").style("fill","#6B7280").text(o),i.append("text").attr("class","axis-label").attr("transform",`translate(${p/2}, ${c+r.bottom-5})`).style("text-anchor","middle").style("font-size",n?"10px":"12px").style("fill","#6B7280").text("Date")}catch(d){console.error("Error creating chart:",d),D(t,"Error creating chart. Please refresh the page.")}}function G(){let t=[...v];const e=document.getElementById("hosp-pathogen-filter")?.value;e&&(t=t.filter(a=>a.pathogen===e));const o=document.getElementById("hosp-date-range")?.value;if(o&&o!=="all"){const a=new Date;let n=new Date;switch(o){case"3months":n.setMonth(a.getMonth()-3);break;case"6months":n.setMonth(a.getMonth()-6);break;case"1year":n.setFullYear(a.getFullYear()-1);break}t=t.filter(l=>l.date>=n)}return t}function J(){let t=[...E];const e=document.getElementById("lab-pathogen-filter")?.value;e&&(t=t.filter(a=>a.pathogen===e));const o=document.getElementById("lab-date-range")?.value;if(o&&o!=="all"){const a=new Date;let n=new Date;switch(o){case"3months":n.setMonth(a.getMonth()-3);break;case"6months":n.setMonth(a.getMonth()-6);break}t=t.filter(l=>l.date>=n)}return t}function K(t,e,o){const a=window.innerWidth<640,l=((y,b)=>{const B=parseInt(y.slice(1,3),16),I=parseInt(y.slice(3,5),16),M=parseInt(y.slice(5,7),16);return`rgba(${B}, ${I}, ${M}, ${b})`})(o,.9),r=d3.select("body").append("div").attr("class","chart-tooltip").style("position","absolute").style("background",l).style("color","white").style("padding",a?"6px 8px":"8px 12px").style("border-radius","4px").style("font-size",a?"10px":"12px").style("pointer-events","none").style("z-index","1000").style("max-width",a?"180px":"300px").style("box-shadow","0 2px 4px rgba(0,0,0,0.2)").html(`
          <strong>${e.pathogen}</strong><br/>
          ${e.metric}: ${e.value.toLocaleString()}<br/>
          Date: ${e.date.toLocaleDateString()}
        `),p=r.node();r.style("left",t.pageX+10+"px").style("top",t.pageY-10+"px");const c=p.getBoundingClientRect(),d=c.width,i=c.height,w=window.innerWidth,u=window.innerHeight,m=window.pageYOffset||document.documentElement.scrollTop,h=window.pageXOffset||document.documentElement.scrollLeft;let f=t.pageX+10,g=t.pageY-10;t.clientX+d+20>w&&(f=t.pageX-d-10),f<h+5&&(f=h+5),t.clientY-i-10<0&&(g=t.pageY+20),t.clientY+i+30>u&&(g=t.pageY-i-10),g<m+5&&(g=m+5),g+i>m+u-5&&(g=m+u-i-5),r.style("left",f+"px").style("top",g+"px")}function Q(){d3.selectAll(".chart-tooltip").remove()}function D(t,e){d3.select(t).append("div").style("text-align","center").style("padding","2rem").style("color","#6B7280").text(e)}function _(){document.getElementById("hosp-pathogen-filter")?.addEventListener("change",()=>{L()}),document.getElementById("hosp-date-range")?.addEventListener("change",()=>{L()}),document.getElementById("lab-pathogen-filter")?.addEventListener("change",()=>{A()}),document.getElementById("lab-date-range")?.addEventListener("change",()=>{A()});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{L(),A()},250)})}function tt(){const t=document.getElementById("hosp-loading"),e=document.getElementById("hosp-chart");t&&(t.style.display="none"),e&&e.classList.remove("hidden")}function et(){const t=document.getElementById("lab-loading"),e=document.getElementById("lab-chart");t&&(t.style.display="none"),e&&e.classList.remove("hidden")}function ot(){N(),R()}function N(){const t=document.getElementById("hosp-loading");t&&(t.innerHTML=`
          <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-red-600">Error loading hospitalization data</p>
          </div>
        `)}function R(){const t=document.getElementById("lab-loading");t&&(t.innerHTML=`
          <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-red-600">Error loading laboratory data</p>
          </div>
        `)}
