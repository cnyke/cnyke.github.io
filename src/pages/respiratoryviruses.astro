---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<script src="https://d3js.org/d3.v7.min.js"></script>

<BaseLayout title="Respiratory Viruses - Resilience Continuum" description="Data visualization exploring respiratory virus patterns and transmission dynamics">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero Section -->
    <div class="text-center mb-8 md:mb-12">
      <h1 class="text-3xl sm:text-4xl md:text-6xl font-bold text-gray-900 mb-4 md:mb-6">
        Respiratory Viruses in Minnesota
      </h1>
        <p class="text-lg sm:text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed px-4">
          This data from October 9th, 2025 explores trends in viral respiratory illnesses. 
        </p>
          <p class="text-base sm:text-lg text-gray-600 max-w-4xl mx-auto leading-relaxed mt-4 px-4">
            Cold and flu season is from October through mid-May. These data visualizations explore viral trends using <a href="https://www.health.state.mn.us/diseases/respiratory/stats/index.html" class="text-blue-600 hover:text-blue-800 break-words" target="_blank" rel="noopener">Minnesota Department of Health data</a>. The first data visualization tracks hospitalizations due to RSV, influenza, and COVID-19. The second covers laboratory-confirmed viruses which cause cold-like symptoms. Note that seasonal coronavirus is distinct from SARS-CoV-2, the virus that causes COVID-19. You can filter by time period and pathogen using the dropdown menus.
          </p>
    </div>

    <!-- Hospitalization Data Chart -->
    <div class="mb-16">
      <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
        <div class="p-4 sm:p-6 bg-gray-50 border-b">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 sm:mb-4">Statewide Hospitalizations Since 2022</h2>
          <p class="text-sm sm:text-base text-gray-600 mb-4">
            Weekly hospitalization rates by pathogen from Minnesota Department of Health surveillance data.
          </p>
          
          <!-- Hospitalization Controls -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
            <div>
              <label for="hosp-pathogen-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Pathogen</label>
              <select id="hosp-pathogen-filter" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="">All Pathogens</option>
              </select>
            </div>
            <div>
              <label for="hosp-date-range" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
              <select id="hosp-date-range" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="all">All Time</option>
                <option value="1year">Last 12 Months</option>
                <option value="6months">Last 6 Months</option>
                <option value="3months">Last 3 Months</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Loading indicator -->
        <div id="hosp-loading" class="p-8 text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
          <p class="text-gray-600">Loading hospitalization data...</p>
        </div>

        <!-- Chart container -->
        <div id="hosp-chart" class="hidden">
          <div class="p-2 sm:p-4">
            <div id="hosp-container" class="w-full chart-container"></div>
          </div>
          <!-- Citation for hospitalization data -->
          <div class="px-4 pb-4 text-xs text-gray-500 border-t bg-gray-50">
            <p class="mt-2">
              <strong>Data Source:</strong> Minnesota Department of Health. Hospitalization Data - Viral Respiratory Illness in Minnesota. 
              <a href="https://www.health.state.mn.us/diseases/respiratory/stats/hosp.html" class="text-blue-600 hover:text-blue-800 break-words" target="_blank" rel="noopener">https://www.health.state.mn.us/diseases/respiratory/stats/hosp.html</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Laboratory Data Chart -->
    <div class="mb-16">
      <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
        <div class="p-4 sm:p-6 bg-gray-50 border-b">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 sm:mb-4">Laboratory System Molecular Data</h2>
          <p class="text-sm sm:text-base text-gray-600 mb-4">
            Weekly laboratory detections by pathogen from Minnesota's molecular testing surveillance system.
          </p>
          
          <!-- Laboratory Controls -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
            <div>
              <label for="lab-pathogen-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Pathogen</label>
              <select id="lab-pathogen-filter" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Pathogens</option>
              </select>
            </div>
            <div>
              <label for="lab-date-range" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
              <select id="lab-date-range" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="all">All Time</option>
                <option value="6months">Last 6 Months</option>
                <option value="3months">Last 3 Months</option>
                <option value="1month">Last Month</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Loading indicator -->
        <div id="lab-loading" class="p-8 text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-gray-600">Loading laboratory data...</p>
        </div>

        <!-- Chart container -->
        <div id="lab-chart" class="hidden">
          <div class="p-2 sm:p-4">
            <div id="lab-container" class="w-full chart-container"></div>
          </div>
          <!-- Citation for laboratory data -->
          <div class="px-4 pb-4 text-xs text-gray-500 border-t bg-gray-50">
            <p class="mt-2">
              <strong>Data Source:</strong> Minnesota Department of Health. Laboratory Data - Viral Respiratory Illness in Minnesota. 
              <a href="https://www.health.state.mn.us/diseases/respiratory/stats/lab.html" class="text-blue-600 hover:text-blue-800 break-words" target="_blank" rel="noopener">https://www.health.state.mn.us/diseases/respiratory/stats/lab.html</a>
            </p>
          </div>
        </div>
      </div>
    </div>


    <!-- Data Sources -->
    <div class="mt-12 bg-white rounded-lg shadow-sm border p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-3">Data Sources</h3>
      <p class="text-sm text-gray-600 mb-3">
        Respiratory Virus Hospitalization Surveillance Network (RESP-NET). (2025). Viral Respiratory Illness in Minnesota. [Data set]. Minnesota Department of Health. <a href="https://www.health.state.mn.us/diseases/respiratory/stats/index.html" class="text-blue-600 hover:text-blue-800 break-words" target="_blank" rel="noopener">https://www.health.state.mn.us/diseases/respiratory/stats/index.html</a>
      </p>
    </div>
  </div>

  <script>
    // Global D3 declaration
    declare const d3: any;

    // Global variables for data
    let hospitalizationData: any[] = [];
    let laboratoryData: any[] = [];

    // Color scheme for different pathogens and metrics - maximally different colors
    const pathogenColors = {
      // First Chart (Hospitalization) - Blue, Orange, Yellow
      'Total': '#6B7280',        // Gray for total
      'COVID-19': '#1E40AF',
      'COVID': '#1E40AF',     // Blue
      'RSV': '#EA580C',          // Orange  
      'Influenza': '#EAB308',    // Yellow
      
      // Second Chart (Laboratory) - Red, Green, Purple, Teal, Pink
      'Adenovirus': '#610b00',   // Red
      'Human Metapneumovirus': '#16A34A',    // Green
      'Parainfluenza Virus 1-4': '#EA580C',  // Orange
      'Parainfluenza Virus 1': '#EA580C',
      'Rhinovirus': '#1192e8',   // Teal
      'Seasonal Coronavirus': '#EC4899',     // Pink
      
      // Legacy mappings for consistency
      'Parainfluenza': '#EA580C', 
      'Metapneumovirus': '#16A34A', 
      'Enterovirus': '#002d9c',   
      'Bocavirus': '#ee538b',     
      'Other': '#b28600'          
    };

    // Initialize the visualization
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Loading respiratory virus data...');
      loadAllData();
    });

    // Load all three datasets
    async function loadAllData() {
      try {
        console.log('Starting to load all data...');
        
        const [hospData, labData] = await Promise.all([
          loadHospitalizationData().catch(e => {
            console.error('Hospitalization data error:', e);
            return [];
          }),
          loadLaboratoryData().catch(e => {
            console.error('Laboratory data error:', e);
            return [];
          })
        ]);

        hospitalizationData = hospData;
        laboratoryData = labData;

        console.log('All data loaded:', {
          hospitalizations: hospitalizationData.length,
          laboratory: laboratoryData.length
        });

        // Initialize all charts with small delay to ensure containers are ready
        setTimeout(() => {
          if (hospitalizationData.length > 0) {
            initializeHospitalizationChart();
          } else {
            console.warn('No hospitalization data available');
            showHospError();
          }
          
          if (laboratoryData.length > 0) {
            initializeLaboratoryChart();
          } else {
            console.warn('No laboratory data available');
            showLabError();
          }
          
          setupEventListeners();
        }, 100);

      } catch (error) {
        console.error('Error loading data:', error);
        showAllErrors();
      }
    }


    // Load hospitalization data
    async function loadHospitalizationData() {
      const response = await fetch('/data/MDHRespiratoryData10.9.25/MDH-statewide-hospitalizations-since-2022.csv');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const csvText = await response.text();
      const lines = csvText.split('\n').filter(line => line.trim());
      
      const data: any[] = [];
      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split('\t');
        if (columns.length >= 15) {
          const dateStr = columns[0]?.trim();
          const pathogen = (columns[11]?.trim() || 'Total');
          const rateStr = columns[14]?.trim();
          
          if (dateStr && rateStr) {
            const rate = parseFloat(rateStr);
            if (!isNaN(rate) && rate >= 0) {
              const date = parseDate(dateStr);
              if (date) {
                data.push({
                  date: date,
                  pathogen: pathogen,
                  value: rate,
                  metric: 'Hospitalization Rate'
                });
              }
            }
          }
        }
      }
      return data;
    }

    // Load laboratory data  
    async function loadLaboratoryData() {
      const response = await fetch('/data/MDHRespiratoryData10.9.25/MDH-laboratory-system-molecular-data-1-year-10.9.25.csv');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const csvText = await response.text();
      const lines = csvText.split('\n').filter(line => line.trim());
      
      const data: any[] = [];
      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split('\t');
        if (columns.length >= 3) {
          const pathogen = columns[0]?.trim();
          const dateStr = columns[1]?.trim();
          const valueStr = columns[2]?.trim();
          
          // Skip empty values
          if (!pathogen || !dateStr || !valueStr) continue;
          
          const value = parseFloat(valueStr);
          
          if (pathogen && dateStr && !isNaN(value) && value > 0) {
            const date = parseDate(dateStr);
            if (date) {
              data.push({
                date: date,
                pathogen: pathogen,
                value: value,
                metric: 'Laboratory Detections'
              });
            }
          }
        }
      }
      return data;
    }


    // Initialize Hospitalization Chart
    function initializeHospitalizationChart() {
      populateHospPathogenFilter();
      createHospitalizationChart();
      hideHospLoadingIndicator();
    }

    // Initialize Laboratory Chart
    function initializeLaboratoryChart() {
      populateLabPathogenFilter();
      createLaboratoryChart();
      hideLabLoadingIndicator();
    }


    // Parse date strings in various formats
    function parseDate(dateStr: string): Date | null {
      if (!dateStr || dateStr.trim() === '') return null;
      
      const cleanDateStr = dateStr.trim();
      
      // Try different date formats
      let date: Date | null = null;
      
      // Format: M/D/YYYY or MM/DD/YYYY
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(cleanDateStr)) {
        date = new Date(cleanDateStr);
      }
      // Format: YYYY-MM-DD
      else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(cleanDateStr)) {
        date = new Date(cleanDateStr);
      }
      // Format: MM/DD/YYYY (try parsing as-is)
      else {
        date = new Date(cleanDateStr);
      }
      
      // Validate the date
      if (date && !isNaN(date.getTime())) {
        // Additional validation - reject obviously wrong dates
        const year = date.getFullYear();
        if (year >= 2020 && year <= 2025) {
          return date;
        }
      }
      
      console.log('Failed to parse date:', cleanDateStr);
      return null;
    }

    // Populate hospitalization pathogen filter
    function populateHospPathogenFilter() {
      const pathogens = new Set<string>();
      hospitalizationData.forEach(d => {
        if (d.pathogen && d.pathogen !== 'Unknown') {
          pathogens.add(d.pathogen);
        }
      });

      const select = document.getElementById('hosp-pathogen-filter') as HTMLSelectElement;
      if (select) {
        // Clear existing options except first
        while (select.children.length > 1) {
          select.removeChild(select.lastChild!);
        }
        
        Array.from(pathogens).sort().forEach(pathogen => {
          const option = document.createElement('option');
          option.value = pathogen;
          option.textContent = pathogen;
          select.appendChild(option);
        });
      }
    }

    // Populate laboratory pathogen filter
    function populateLabPathogenFilter() {
      const pathogens = new Set<string>();
      laboratoryData.forEach(d => {
        if (d.pathogen && d.pathogen !== 'Unknown') {
          pathogens.add(d.pathogen);
        }
      });

      const select = document.getElementById('lab-pathogen-filter') as HTMLSelectElement;
      if (select) {
        // Clear existing options except first
        while (select.children.length > 1) {
          select.removeChild(select.lastChild!);
        }
        
        Array.from(pathogens).sort().forEach(pathogen => {
          const option = document.createElement('option');
          option.value = pathogen;
          option.textContent = pathogen;
          select.appendChild(option);
        });
      }
    }

    // Create hospitalization chart
    function createHospitalizationChart() {
      const container = document.getElementById('hosp-container');
      if (!container) return;

      // Clear any existing chart
      d3.select(container).selectAll('*').remove();

      // Get filtered data
      const filteredData = getHospFilteredData();
      
      if (filteredData.length === 0) {
        showNoDataMessage(container, 'No hospitalization data available for the selected filters');
        return;
      }

      createChart(container, filteredData, 'Hospitalization Rate', pathogenColors['COVID-19']);
    }

    // Create laboratory chart
    function createLaboratoryChart() {
      const container = document.getElementById('lab-container');
      if (!container) return;

      // Clear any existing chart
      d3.select(container).selectAll('*').remove();

      // Get filtered data
      const filteredData = getLabFilteredData();
      
      if (filteredData.length === 0) {
        showNoDataMessage(container, 'No laboratory data available for the selected filters');
        return;
      }

      createChart(container, filteredData, 'Laboratory Detections', pathogenColors['RSV']);
    }



    // Create legend
    function createLegend(g: any, width: number, keys: string[]) {
      const isMobile = window.innerWidth < 640;
      const isTablet = window.innerWidth < 1024;
      
      const legend = g.append('g')
        .attr('class', 'legend')
        .attr('transform', `translate(${width + 10}, 20)`);

      // Limit legend items based on screen size
      const maxItems = isMobile ? 4 : isTablet ? 6 : 8;
      keys.slice(0, maxItems).forEach((key, i) => {
        const [pathogen, metric] = key.split('-');
        
        // Use the same color logic as the line drawing - always use predefined color
        const color = pathogenColors[pathogen as keyof typeof pathogenColors] || '#6B7280';

        const legendItem = legend.append('g')
          .attr('transform', `translate(0, ${i * (isMobile ? 16 : 20)})`);

        legendItem.append('line')
          .attr('x1', 0)
          .attr('x2', isMobile ? 12 : 15)
          .attr('stroke', color)
          .attr('stroke-width', isMobile ? 1.5 : 2);

        legendItem.append('text')
          .attr('x', isMobile ? 16 : 20)
          .attr('y', 0)
          .attr('dy', '0.35em')
          .style('font-size', isMobile ? '9px' : '11px')
          .style('fill', '#374151')
          .text(pathogen);
      });
    }

    // Generic chart creation function
    function createChart(container: HTMLElement, data: any[], yAxisLabel: string, defaultColor: string) {
      // Validate container dimensions with retry
      if (container.clientWidth === 0) {
        console.log('Container width is 0, waiting for layout...');
        setTimeout(() => {
          if (container.clientWidth > 0) {
            createChart(container, data, yAxisLabel, defaultColor);
          } else {
            showNoDataMessage(container, 'Chart container not ready. Please refresh the page.');
          }
        }, 100);
        return;
      }
      
      // Responsive dimensions based on screen size
      const isMobile = window.innerWidth < 640; // sm breakpoint
      const isTablet = window.innerWidth < 1024; // lg breakpoint
      
      // Adjust margins and legend space based on screen size
      const margin = isMobile 
        ? { top: 20, right: 20, bottom: 70, left: 50 }  // More space for x-axis labels on mobile
        : isTablet 
        ? { top: 20, right: 100, bottom: 80, left: 60 } // More space for x-axis labels on tablet
        : { top: 20, right: 180, bottom: 80, left: 80 }; // More space for x-axis labels on desktop
      
      const width = Math.max(250, container.clientWidth - margin.left - margin.right);
      const height = Math.max(200, container.clientHeight || 300) - margin.top - margin.bottom;
      
      // Validate data
      if (!data || data.length === 0) {
        showNoDataMessage(container, 'No data available for this chart.');
        return;
      }

      try {
        // Create SVG
        const svg = d3.select(container)
          .append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom);

        const g = svg.append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

      // Set up scales
      const dateExtent = d3.extent(data, (d: any) => d.date);
      const valueExtent = d3.extent(data, (d: any) => d.value);

      const xScale = d3.scaleTime()
        .domain(dateExtent)
        .range([0, width]);

      const yScale = d3.scaleLinear()
        .domain([0, valueExtent[1] * 1.1])
        .range([height, 0]);

      // Create axes with responsive formatting
      const xAxis = d3.axisBottom(xScale)
        .tickFormat(d3.timeFormat('%b %Y'));
      
      const yAxis = d3.axisLeft(yScale)
        .tickFormat(isMobile ? d3.format('.0f') : d3.format('.1f'));

      g.append('g')
        .attr('class', 'x-axis')
        .attr('transform', `translate(0,${height})`)
        .call(xAxis)
        .selectAll('text')
        .style('text-anchor', 'end')
        .style('font-size', isMobile ? '10px' : '12px')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', isMobile ? 'rotate(-45)' : 'rotate(-45)');

      g.append('g')
        .attr('class', 'y-axis')
        .call(yAxis)
        .selectAll('text')
        .style('font-size', isMobile ? '10px' : '12px');

      // Group data by pathogen and metric
      const groupedData = d3.group(data, 
        (d: any) => `${d.pathogen}-${d.metric || 'default'}`
      );

      // Create line generator
      const line = d3.line()
        .x((d: any) => xScale(d.date))
        .y((d: any) => yScale(d.value))
        .curve(d3.curveLinear);

      // Draw lines for each group
      groupedData.forEach((values: any, key: any) => {
        const [pathogen, metric] = key.split('-');
        const sortedValues = values.sort((a: any, b: any) => a.date - b.date);
        
        // Get color for this pathogen - always use the predefined color
        const color = pathogenColors[pathogen as keyof typeof pathogenColors] || defaultColor;

        // Draw the line
        g.append('path')
          .datum(sortedValues)
          .attr('class', `line pathogen-${pathogen.replace(/[^a-zA-Z0-9]/g, '')}`)
          .attr('fill', 'none')
          .attr('stroke', color)
          .attr('stroke-width', 2)
          .attr('opacity', 0.8)
          .attr('d', line);

        // Add dots for data points
        g.selectAll(`.dot-${pathogen.replace(/[^a-zA-Z0-9]/g, '')}-${metric}`)
          .data(sortedValues)
          .enter().append('circle')
          .attr('class', `dot pathogen-${pathogen.replace(/[^a-zA-Z0-9]/g, '')}`)
          .attr('cx', (d: any) => xScale(d.date))
          .attr('cy', (d: any) => yScale(d.value))
          .attr('r', 3)
          .attr('fill', color)
          .attr('opacity', 0.7)
          .on('mouseover', function(event: any, d: any) {
            showTooltip(event, d);
          })
          .on('mouseout', hideTooltip);
      });

      // Add legend only if there's space (not on mobile)
      if (!isMobile) {
        createLegend(g, width, Array.from(groupedData.keys()));
      }

      // Add axis labels with responsive sizing
      g.append('text')
        .attr('class', 'axis-label')
        .attr('transform', 'rotate(-90)')
        .attr('y', 0 - margin.left)
        .attr('x', 0 - (height / 2))
        .attr('dy', '1em')
        .style('text-anchor', 'middle')
        .style('font-size', isMobile ? '10px' : '12px')
        .style('fill', '#6B7280')
        .text(yAxisLabel);

      g.append('text')
        .attr('class', 'axis-label')
        .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 5})`)
        .style('text-anchor', 'middle')
        .style('font-size', isMobile ? '10px' : '12px')
        .style('fill', '#6B7280')
        .text('Date');
        
      } catch (error) {
        console.error('Error creating chart:', error);
        showNoDataMessage(container, 'Error creating chart. Please refresh the page.');
      }
    }

    // Get filtered hospitalization data
    function getHospFilteredData() {
      let filtered = [...hospitalizationData];

      // Filter by pathogen
      const pathogenFilter = (document.getElementById('hosp-pathogen-filter') as HTMLSelectElement)?.value;
      if (pathogenFilter) {
        filtered = filtered.filter(d => d.pathogen === pathogenFilter);
      }

      // Filter by date range
      const dateRange = (document.getElementById('hosp-date-range') as HTMLSelectElement)?.value;
      if (dateRange && dateRange !== 'all') {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (dateRange) {
          case '3months':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
          case '6months':
            cutoffDate.setMonth(now.getMonth() - 6);
            break;
          case '1year':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        }
        
        filtered = filtered.filter(d => d.date >= cutoffDate);
      }

      return filtered;
    }

    // Get filtered laboratory data
    function getLabFilteredData() {
      let filtered = [...laboratoryData];

      // Filter by pathogen
      const pathogenFilter = (document.getElementById('lab-pathogen-filter') as HTMLSelectElement)?.value;
      if (pathogenFilter) {
        filtered = filtered.filter(d => d.pathogen === pathogenFilter);
      }

      // Filter by date range
      const dateRange = (document.getElementById('lab-date-range') as HTMLSelectElement)?.value;
      if (dateRange && dateRange !== 'all') {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (dateRange) {
          case '1month':
            cutoffDate.setMonth(now.getMonth() - 1);
            break;
          case '3months':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
          case '6months':
            cutoffDate.setMonth(now.getMonth() - 6);
            break;
        }
        
        filtered = filtered.filter(d => d.date >= cutoffDate);
      }

      return filtered;
    }


    // Show tooltip on hover
    function showTooltip(event: any, d: any) {
      const isMobile = window.innerWidth < 640;
      
      const tooltip = d3.select('body').append('div')
        .attr('class', 'chart-tooltip')
        .style('position', 'absolute')
        .style('background', 'rgba(0, 0, 0, 0.8)')
        .style('color', 'white')
        .style('padding', isMobile ? '6px 8px' : '8px 12px')
        .style('border-radius', '4px')
        .style('font-size', isMobile ? '10px' : '12px')
        .style('pointer-events', 'none')
        .style('z-index', '1000')
        .style('max-width', isMobile ? '200px' : 'none')
        .html(`
          <strong>${d.pathogen}</strong><br/>
          ${d.metric}: ${d.value.toLocaleString()}<br/>
          Date: ${d.date.toLocaleDateString()}
        `);

      // Position tooltip to avoid going off-screen on mobile
      const tooltipWidth = 200; // Approximate tooltip width
      const tooltipHeight = 60; // Approximate tooltip height
      let left = event.pageX + 10;
      let top = event.pageY - 10;
      
      if (isMobile) {
        // Adjust position to keep tooltip on screen
        if (left + tooltipWidth > window.innerWidth) {
          left = event.pageX - tooltipWidth - 10;
        }
        if (top < 0) {
          top = event.pageY + 10;
        }
      }

      tooltip
        .style('left', left + 'px')
        .style('top', top + 'px');
    }

    // Hide tooltip
    function hideTooltip() {
      d3.selectAll('.chart-tooltip').remove();
    }

    // Show no data message
    function showNoDataMessage(container: HTMLElement, message: string) {
      d3.select(container)
        .append('div')
        .style('text-align', 'center')
        .style('padding', '2rem')
        .style('color', '#6B7280')
        .text(message);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Hospitalization chart listeners
      document.getElementById('hosp-pathogen-filter')?.addEventListener('change', () => {
        createHospitalizationChart();
      });
      document.getElementById('hosp-date-range')?.addEventListener('change', () => {
        createHospitalizationChart();
      });

      // Laboratory chart listeners
      document.getElementById('lab-pathogen-filter')?.addEventListener('change', () => {
        createLaboratoryChart();
      });
      document.getElementById('lab-date-range')?.addEventListener('change', () => {
        createLaboratoryChart();
      });


      // Window resize handler
      let resizeTimeout: ReturnType<typeof setTimeout>;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          createHospitalizationChart();
          createLaboratoryChart();
        }, 250);
      });
    }

    // Hide loading indicators
    function hideHospLoadingIndicator() {
      const loading = document.getElementById('hosp-loading');
      const chart = document.getElementById('hosp-chart');
      
      if (loading) loading.style.display = 'none';
      if (chart) chart.classList.remove('hidden');
    }

    function hideLabLoadingIndicator() {
      const loading = document.getElementById('lab-loading');
      const chart = document.getElementById('lab-chart');
      
      if (loading) loading.style.display = 'none';
      if (chart) chart.classList.remove('hidden');
    }


    // Show error messages
    function showAllErrors() {
      showHospError();
      showLabError();
    }

    function showHospError() {
      const loading = document.getElementById('hosp-loading');
      if (loading) {
        loading.innerHTML = `
          <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-red-600">Error loading hospitalization data</p>
          </div>
        `;
      }
    }

    function showLabError() {
      const loading = document.getElementById('lab-loading');
      if (loading) {
        loading.innerHTML = `
          <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <p class="text-red-600">Error loading laboratory data</p>
          </div>
        `;
      }
    }

  </script>

  <style>
    /* Mobile-first responsive styles */
    .disabled-filter {
      background-color: #f3f4f6;
      cursor: not-allowed;
    }
    
    /* Chart container responsive behavior */
    .chart-container {
      min-height: 250px;
      height: 300px;
    }
    
    @media (min-width: 640px) {
      .chart-container {
        height: 350px;
      }
    }
    
    @media (min-width: 1024px) {
      .chart-container {
        height: 400px;
      }
    }
    
    /* Mobile-optimized tooltips */
    .chart-tooltip {
      word-wrap: break-word;
      white-space: normal;
    }
    
    /* Responsive text sizing */
    @media (max-width: 639px) {
      .text-responsive {
        font-size: 0.875rem;
      }
    }
    
    /* Ensure charts don't overflow on mobile */
    svg {
      max-width: 100%;
      height: auto;
    }
    
    /* Mobile-friendly form controls */
    @media (max-width: 639px) {
      select {
        font-size: 14px;
        padding: 8px 12px;
      }
      
      label {
        font-size: 14px;
      }
    }
    
    /* Ensure links wrap properly and don't overflow */
    a {
      word-break: break-all;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    /* Specific styling for long URLs */
    a[href^="http"] {
      word-break: break-all;
      overflow-wrap: anywhere;
    }
  </style>
</BaseLayout>
